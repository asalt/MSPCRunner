---
# https://yihui.org/knitr/options/#code-evaluation
title: "`r params$title`"
mainfont: Noto Sans
output: 
  html_document: 
    df_print: kable
    #df_print: paged
    code_folding: hide
    highlight: kate   # pygments, kate, monochrome zenburn
    toc: yes
    toc_float: 
      collapsed: false # show full toc
      smooth_scroll: true # toc scrolling behavior
      #code_folding: hide
latex_engine: lualatex
tidy: formatR
params:
    title: "default"
    directory: "/mnt/e/MSPC000856/"
    expids:
        - "50197"
        - "50198"
        - "50199"
        - "50200"
        - "50201"
---

```{r collapse=TRUE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(reactable))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(ggpubr))
suppressPackageStartupMessages(library(vroom))
suppressPackageStartupMessages(library(formattable))
```
# Introduction

## Phosphopetidomics

Questions to answer

- signal intensity
- recovery numbers 
    - total phosphopetides 
    - unique phospho peptides
    - common phosphopeptides
    - single/multi site
- enrichment efficiency
- hydrophobicity
- reproducibility
- method stability
    - TMT HPLC fractionation pools



```{r include=F}
BCMBLUE <- "#002396"
knitr::knit_hooks$set(debug = function(before, options, envir) {
    if (!before) {
        message(
            paste(names(envir), as.list(envir),
                sep = " = ", collapse = "\n"
            )
        )
    }
})
```



## Colors
```{r}
  .col <- circlize::colorRamp2(c(-300, 0, 300), c('red', 'grey40', 'green'))
  scorecol <- circlize::colorRamp2(c(0, 20, 50), c('#abe4ff', '#151269', '#040145'))
  massdiff_col <- colDef(style = function(value) {
    list( color = col(value) )
    }
    )
  score_col <- colDef(style = function(value){
      list(color = scorecol(value) )
  }
  )
  
  map_to_color_fn <- function( .col ) { # callable -> list
    colDef(style = function(value) {
       list( color =  .col(value) )
      }
    )
  }
  
```

## myjstable

```{r include=F}
myjstable <- function(.q, defaultSorted=NULL,
                     searchable = T, striped = T, resizable = T,
                     filterable = T, defaultPageSize = 4,
                     highlight = T, showSortable = T, showSortIcon = T,
                     compact = T, onClick = 'select', 
                     ...
                      ) {
  .q %>%
    rename_with( function(.) str_replace_all(., '_', ' ')) %>% 
    reactable::reactable( searchable = searchable, striped = striped, resizable = resizable,
                          filterable = filterable, 
                          defaultPageSize = defaultPageSize,
                           highlight = highlight, showSortable = showSortable,
                          showSortIcon = showSortIcon,
                          compact = compact, onClick = onClick, 
                          defaultSorted = defaultSorted,
                           )
  
}
                           # defaultSorted = list(`Hyperscore`="desc"),
                           # columns = list(
                           #   massdiff = massdiff_col,
                           #                 Hyperscore = map_to_color_fn(scorecol),
                           #                 nextscore = map_to_color_fn(scorecol),
                           #                 `score without delta mass` = map_to_color_fn(scorecol),
                           #                 `best score with delta mass` = map_to_color_fn(scorecol),
                           #                 `second best score with delta mass` = map_to_color_fn(scorecol)
                           #                 #`score without delta mass` = map_to_color(`score without delta mass`, scorecol)
                           #                 )
                           # #groupBy = "peptide"
                           
# }
```

```{r, include=F}
knitr::opts_chunk$get("title")
title <- params$title
#print(title)
expids <- params$expids
directory <- params$directory
knitr::opts_chunk$set(echo = params$expids)
# print(expids)
# print(params$expids)
# print(directory)
# print('hi')
# expids = c("45278", "45279", "45280", "45281", "45282")
# print(params$directory)
```


```{r label="func def for nice table print"}

stat_summary_formatters <- list(
    mean = color_bar('skyblue'),
    sd = color_tile('white', "red"),
    median = color_bar('green'),
    max = color_tile("white", "green"),
    min = color_tile("white",  "red"),
    sd = color_bar("lightorange"),
    `9606` = color_bar("lightblue"),
    `10090` = color_bar("lightgreen"),
    count = color_bar('grey'),
    ratio = color_tile("#2e0101", '#c80101')
  )

# output nice looking tables
mytable <- function(data, digits=4, booktabs=TRUE, caption="", 
                    formatters = stat_summary_formatters,
                    align='l',
                    ...) 
  {
  
  TABLE_WIDTH <- dim(data)[2]
  TABLE_LENGTH <- dim(data)[1]
  
    formattable::format_table(data, 
                 align="r",
                 digits = digits,
                 caption=glue::glue('<h3 style="color:#002396; background-color=#693200"><strong>', caption, "</strong></h3>", sep=""),
                 formatters=formatters,
                 fixed_header=list(enabled = T,
                                   background = "anycolor"
                                   ),
                 ... 
          )  %>%
    kableExtra::column_spec(1:TABLE_WIDTH, bold=T) %>% 
    kableExtra::row_spec(0, bold=T, font_size='xx-large', align='right', background=paste0(BCMBLUE, "55")) %>% 
         kableExtra::kable_styling(
           bootstrap_options = c("striped", "scale_down", "hover", "condensed", "responsive"),
           html_font = "Noto Sans"
                                  )  
  #
}
    # kableExtra::kable_material()  %>% 


    
  
# mytable <-  function(...)  formattable::format_table(...,  booktabs = TRUE, digits = 4  ) 
```


```{r label="func def for summarizing continuous data"}
# in the future, likely to replace with tools provided in: https://github.com/easystats/report
# and/or https://github.com/ddsjoberg/gtsummary
calc_stat_summary <- function(.x, .var) {
    .x %>%
        summarize(
            mean = mean({{ .var }}, na.rm=T),
            sd = sd({{ .var }}, na.rm = T),
            median = median({{ .var }}, na.rm=T),
            max = max({{ .var }}, na.rm=T),
            min = min({{ .var }}, na.rm=T),
            .groups = "keep"
        )
}


```

```{r, include=F}
name_abbrev <- function(.x) {
    .x
}
```


# load

## e2g

```{r, label="findfiles", eval=F, include=F, debug=F}
# prof <- c("45278", "45279", "45280", "45281", "45282") %>%
# map(~ glue::glue("../gpgrouped/", .x, "*e2g_QUAL.tsv")) %>%
# ptinyz9
files <- expids %>%
    map(~ glue::glue(.x, ".*e2g_QUAL.tsv")) %>%
    map(~ fs::dir_ls(path = directory, regexp = .x, recurse = T)) %>%
    flatten() %>%
    unlist(use.names = F)


message(
    paste(names(files), files,
        sep = " = ", collapse = "\n"
    )
)
myjstable(files)
```

```{r, label="load data", include=F}

df <- expids %>%
    map(~ glue::glue(.x, ".*e2g_QUAL.tsv")) %>%
    map(~ fs::dir_ls(path = directory, regexp = .x, recurse = T)) %>%
    flatten() %>%
    unlist(use.names = F) %>%
    map(~ vroom(.x, n_max = Inf) %>% mutate(id = fs::path_file(.x))) %>%
    map(~ mutate(.x,
        GeneID = as.character(GeneID),
        TaxonID = as.character(TaxonID),
        LabelFLAG = as.character(LabelFLAG),
        GPGroups_All = as.character(GPGroups_All),
    )) %>%
    bind_rows()

```


```{r, label='count'}
df %>%
    count(id, EXPRecNo) %>%
  mytable()
```

```{r}
.func <- function() {
    df %>%
        dplyr::filter(SRA == "S" & str_detect(GeneID, "sp_", negate = T) & !TaxonID == "NA") %>%
        group_by(id, TaxonID) %>%
        summarize(n_distinct = n_distinct(GeneID), .groups = "keep")
}

.func() %>%
    ungroup() %>%
    pivot_wider(id_cols = "id", names_from = "TaxonID", values_from = "n_distinct") %>%
    mytable(
      caption="strict level geneids per taxon"
    )
```
```{r}

.func() %>%
    pivot_wider(id_cols = "id", names_from = "TaxonID", values_from = "n_distinct") %>%
    pivot_longer(-id, names_to = "TaxonID", values_to = "n_Strict") %>%
    group_by(TaxonID) %>%
    calc_stat_summary(n_Strict) %>%
    mytable(
      caption="strict level geneids per taxon"
    )
```


# 
```{r}

.func <- function() {
    df %>%
        dplyr::filter(SRA == "S" & str_detect(GeneID, "sp_", negate = T) & !TaxonID == "NA" & PeptideCount > 1) %>%
        group_by(id, TaxonID) %>%
        summarize(n_distinct = n_distinct(GeneID), .groups = "keep")
}

.func() %>%
    ungroup() %>%
    pivot_wider(id_cols = "id", names_from = "TaxonID", values_from = "n_distinct") %>%
    mytable(
      caption = "number of strict level geneids with 2 or more peptides per taxon"
    )

.func() %>%
    pivot_wider(id_cols = "id", names_from = "TaxonID", values_from = "n_distinct") %>%
    pivot_longer(-id, names_to = "TaxonID", values_to = "n_Strict") %>%
    group_by(TaxonID) %>%
    calc_stat_summary(n_Strict) %>%
    mytable(
      caption = "number of strict level geneids with 2 or more peptides per taxon"
    )
```



# PSMs
```{r PSM LOADING, message=TRUE, include=F}

.files <- expids %>%
    map(~ glue::glue(.x, ".*psms?_QUAL.tsv")) %>%
    map(~ fs::dir_ls(path = directory, regexp = .x, recurse = T)) %>%
    flatten() %>%
    map(~ unlist(.x))

dfp <- .files %>%
    map(~ vroom(.x, n_max = Inf, show_col_types = F) %>% mutate(id = fs::path_file(.x))) %>%
    map(~ filter(.x, oriFLAG == 1)) %>%
    map(~ mutate(.x,
        GeneID = as.character(GeneID),
        TaxonID = as.character(TaxonID),
        HIDs = as.character(HIDs),
        LabelFLAG = as.character(LabelFLAG),
    )) %>%
    bind_rows()

# map(~ read_tsv(.x) %>% mutate(id = fs::path_file(.x))) %>%
# SpectrumFile is still SpecId for msfragger output, need to parse out the raw file name
# .dfp <-.dfp %>% mutate(SpectrumFile=coalesce(SpectrumFile, SpecId))

# .dfp <-.dfp %>% mutate(SpectrumFile=coalesce(SpectrumFile, SpecId))
if (!"SpecId" %in% colnames(dfp)) {
    dfp <- dfp %>% mutate(SpecId = SpectrumFile)
}

dfp <- dfp %>% mutate(SpectrumFile = coalesce(SpectrumFile, filename))
# dfp <-dfp %>% mutate(SpectrumFile=coalesce(SpectrumFile, SpecId))
# dfp <-dfp %>% mutate(SpectrumFile=coalesce(SpecId, SpectrumFile))
dfp <- dfp %>% mutate(SpectrumFile = coalesce(SpectrumFile, filename))

if (!"SpectrumFile" %in% colnames(dfp)) {
    dfp <- dfp %>% mutate(SpectrumFile = str_extract(SpecId, "(.*[f|F]?\\d)(?=\\.\\d+\\.\\d+\\.\\d+)"))
}

# hack
if (dfp %>% pull(SpectrumFile) %>% n_distinct() > 9999) {
    dfp <- dfp %>% mutate(SpectrumFile = str_extract(SpectrumFile, "(.*[f|F]?[\\d|a|A])(?=\\.\\d+\\.\\d+\\.\\d+)"))
}
# map( ~ select(.x, GeneID, TaxonID, SequenceModi)) #%>%

dfp <- dfp %>%
    mutate(miscuts = stringr::str_count(dfp$Sequence, "K|R") - 1) %>%
    mutate(miscuts = recode(miscuts, `-1` = 0))

# for some reason ParentIonMZ column is not present, though it should be
# dfp <- dfp %>% mutate(
#     DeltaMassPPM =
#         ((MZ - ParentIonMZ) / ParentIonMZ) * 10^6
# )
```




# n files
```{r, eval=T}
dfp %>%
  pull(SpectrumFile) %>%
  n_distinct()
#%>%  mytable()
```
```{r}

dfp %>%
    count(SpectrumFile) %>%
    mytable(formatters=stat_summary_formatters)

```

```{r, eval=F, include=F, results = "asis", }
# doesn't WORK
unique_exps <- unique(dfp$EXPRecNo)
print(unique_exps)

dfp %>%
    dplyr::filter(EXPRecNo == unique_exps[1]) %>%
    count(SpectrumFile) %>%
    arrange(SpectrumFile) %>%
  mytable(
    formatters=stat_summary_formatters
  )
seq_along(unique_exps)
for (i in seq_along(unique_exps)) {
    .x <- dfp %>%
        dplyr::filter(EXPRecNo == unique_exps[i]) %>%
        count(SpectrumFile) %>%
        arrange(SpectrumFile)
    print(.x)

    # %>%
    #    knitr::kable() %>% kable_styling()
    print(.x)
    cat("\n")


    # %>% kable_styling(font_size=6))
    # cat('\n')
}
```

# count per spec file
```{r, eval=T}
spec_stats <- dfp %>%
    dplyr::filter(str_detect(GeneID, "sp_", negate = T) & !TaxonID == "NA") %>%
    group_by(id) %>%
    summarize(
        specids = n_distinct(SpecId), n_distinct_Sequence =
            n_distinct(Sequence), .groups = "keep"
    ) %>%
    ungroup()
.caption <- "count per spec file"
# %>%
#   pivot_wider(id_cols = "id",
#               values_from = c('specids', "n_distinct_Sequence"))
mytable(spec_stats, caption = .caption)
# ggbarplot(data = spec_stats, y = "id", x = "n_distinct_Sequence")
```
```{r, eval=F}
library(formattable)
df <- data.frame(
  id = 1:10,
  name = c("Bob", "Ashley", "James", "David", "Jenny",
    "Hans", "Leo", "John", "Emily", "Lee"),
  age = c(28, 27, 30, 28, 29, 29, 27, 27, 31, 30),
  grade = c("C", "A", "A", "C", "B", "B", "B", "A", "C", "C"),
  test1_score = c(8.9, 9.5, 9.6, 8.9, 9.1, 9.3, 9.3, 9.9, 8.5, 8.6),
  test2_score = c(9.1, 9.1, 9.2, 9.1, 8.9, 8.5, 9.2, 9.3, 9.1, 8.8),
  final_score = c(9, 9.3, 9.4, 9, 9, 8.9, 9.25, 9.6, 8.8, 8.7),
  registered = c(TRUE, FALSE, TRUE, FALSE, TRUE, TRUE, TRUE, FALSE, FALSE, FALSE),
  stringsAsFactors = FALSE)
formattable(df, list(
  age = color_tile("white", "orange"),
  grade = formatter("span", style = x ~ ifelse(x == "A",
    style(color = "green", font.weight = "bold"), NA)),
  area(col = c(test1_score, test2_score)) ~ normalize_bar("pink", 0.2),
  final_score = formatter("span",
    style = x ~ style(color = ifelse(rank(-x) <= 3, "green", "gray")),
    x ~ sprintf("%.2f (rank: %02d)", x, rank(-x))),
  registered = formatter("span",
    style = x ~ style(color = ifelse(x, "green", "red")),
    x ~ icontext(ifelse(x, "ok", "remove"), ifelse(x, "Yes", "No")))
))
```



# miscuts avg
```{r, eval=T}
miscut_stats <- dfp %>%
    dplyr::filter(str_detect(GeneID, "sp_", negate = T) & !TaxonID == "NA") %>%
    group_by(id) %>%
    count(miscuts) %>%
    summarize(miscuts = miscuts, count = n, ratio = n / sum(n)) %>%
    ungroup()
```

```{r}
.caption <- 'Miscuts'
miscut_stats %>% mytable(caption=.caption)
```


```{r, label="Miscut graph"}
ggbarplot(data = miscut_stats, y = "id", x = "count", fill = "miscuts")
```


# count per taxon

```{r, eval=F}
dfp %>%
    dplyr::filter(str_detect(GeneID, "sp_", negate = T) & !TaxonID == "NA") %>%
    group_by(SpectrumFile, TaxonID) %>%
    summarize(specids = n_distinct(SpecId), n_distinct_Sequence = n_distinct(Sequence), .groups = "keep") %>%
    ungroup() %>%
    arrange(SpectrumFile) %>%
    mytable(formatters=list(
      specids = color_bar("lightblue"),
      specids = color_bar("lightblue")
    ))

```

# mass error plot
#

```{r mass error plot, fig.height=10}
dfp %>%
    dplyr::filter(str_detect(GeneID, "sp_", negate = T) & !TaxonID == "NA") %>%
    group_by(id, SpectrumFile) %>%
    ggpubr::ggviolin(
        x = "SpectrumFile", y = "DeltaMassPPM", x.text.angle = 45, font.ytickslab = 6,
        main = "DeltaMassPPM",
        orientation = "horiz",
    )
```

# mass error stats
 
```{r mass error stats}
 # (note delta mass ppm not available)
.res <- dfp %>%
    dplyr::filter(str_detect(GeneID, "sp_", negate = T) & !TaxonID == "NA") %>%
    group_by(id, SpectrumFile) %>%
    calc_stat_summary(DeltaMassDa) %>%
    ungroup() 

.res %>%  select(-id) %>% mytable( formatters=stat_summary_formatters )
```
# overall SN ratio
```{r, label='sn ratio stats'}
dfp %>%
    dplyr::filter(str_detect(GeneID, "sp_", negate = T) & !TaxonID == "NA") %>%
    group_by(filename) %>%
    calc_stat_summary(PeakSignalToNoiseRatio) %>%
    ungroup() %>%
    mytable( formatters = stat_summary_formatters )
```


# Peak Skew
```{r, include=F}
dfp %>%
    dplyr::filter(str_detect(GeneID, "sp_", negate = T) & !TaxonID == "NA") %>%
    group_by(id, SpectrumFile) %>%
    calc_stat_summary(PeakSkew) %>%
    ungroup() %>%
    select(-id) %>%
    mytable( formatters = stat_summary_formatters )
    #mytable( formatters=stat_summary_formatters )
```


# Phospho


```{r}
# look for site data
site_files <- expids %>%
    map(~ glue::glue(.x, ".*site_table_nr.tsv")) %>%
    map(~ fs::dir_ls(path = directory, regexp = .x, recurse = T)) %>%
    unlist()

SITE_DATA <- if_else(length(site_files) > 0, T, F)
site_files
```

```{r, eval=SITE_DATA, include=F}
sites <- site_files %>%
    map(~ read_tsv(.x, show_col_types = F) %>% mutate(id = fs::path_file(.x))) %>%
    map(~ mutate(.x,
        GeneID = as.character(GeneID),
        #TaxonID = as.character(TaxonID),
        #LabelFLAG = as.character(LabelFLAG),
        #GPGroups_All = as.character(GPGroups_All),
    )) %>%
    bind_rows()
```


```{r, eval=SITE_DATA}
"Distinct sites"

.stats <- sites %>%
    filter(AA %in% c("S", "T", "Y")) %>%
    group_by(id) %>%
    summarise(
        tot = n(),
        unique_sites = n_distinct(Site),
        tot_geneids = n_distinct(GeneID)
    ) 

.stats %>% ungroup %>% mytable(
       formatter=list(
        tot =  color_bar('lightblue'),
        unique_sites =  color_bar('lightgreen'),
        tot_geneids =  color_bar('lightpurple')
      )
)
```


```{r, eval=SITE_DATA}

sites %>%
    filter(AA %in% c("S", "T", "Y")) %>%
    group_by(id, AA) %>%
    summarise(
        tot = n(),
        unique_sites = n_distinct(Site),
        tot_geneids = n_distinct(GeneID)
    ) %>%
    mytable(
       formatter=list(
        tot =  color_bar('lightblue'),
        unique_sites =  color_bar('lightgreen'),
        tot_geneids =  color_bar('lightpurple')
       )
    )
```
